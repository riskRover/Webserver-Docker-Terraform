name: Run Docker Container with Terraform

on:
  push:
    branches:
      - 'ma**'
    tags:
      - 'v*.*.*'

jobs:
  Build:
    runs-on: self-hosted
    steps:
      - name: Cleanup build folder
        run: |
          ls -la ./
          rm -rf ./* || true
          rm -rf ./.??* || true
          ls -la ./
      - name: Chekout Repository
        uses: actions/checkout@v4
      - name: Check Working directory location and Prerequisites
        shell: bash
        run: |
         pwd
         ls -la
         terraform version
         docker version
      - name: Check Docker Container is exist
        id: check_container
        run: |
          if docker ps --filter "name=webcontainer" --filter "status=running" | grep webcontainer; then
            echo "status=running" >> $GITHUB_OUTPUT
          else
            echo "status=not_running" >> $GITHUB_OUTPUT
          fi
      - name: Stop Docker Container Running
        if: ${{ steps.check_container.outputs.status == 'running' }}
        run: |
          echo "Stopping the Docker container..."
          docker stop webcontainer || true
          docker rm webcontainer || true
      - name: Terraform init
        run: terraform init
      - name: Terraform plan
        run: terraform plan
      - name: Terraform Apply Logic
        run: terraform apply -auto-approve
